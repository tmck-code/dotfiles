#!/bin/bash

set -euo pipefail
[ -n "${DEBUG:-}" ] && set -x

function usage() {
  echo "Usage: $0 <file> [speed]" >&2
}

function scroll() {
  local fpath="$1"
  local enable_scroll="$2"
  local delay="${3:-0.5}"
  clear -x
  echo "[$fpath]"
  sleep 0.1

  # head -n "$(tput lines)" "$fpath"
  # ^ this minus 2
  head -n $(( $(tput lines) - 2 )) "$fpath"

  if [[ "$enable_scroll" != "0" ]]; then
    return 0
  fi

  local i=0
  while read -r; do
    echo -e "$REPLY\x1b[0m" || echo # TODO: look into this ENV var and why it works
    sleep "${delay:-0.5}"

    # if any key is pressed, exit
    if read -rsn1 -t 0.1 key < /dev/tty; then
      [[ -z "$key" ]] && return 1 || true
    fi

    i=$((i+1))
  done < <(tail -n +"$(tput lines)" "$fpath")

  # [[ $i -lt $(tpu lines) ]] && sleep 20 || sleep 5
}

function wait_for_keypress() {
  local wait_time="${1:-5}"

  read -rsn1 -t "$wait_time" key < /dev/tty || true
  [[ -z "$key" ]] && return 1 || return 0
}

function scroll_all() {
  local delay="${1:-0.5}"
  local pause_time="${2:-5}"
  local enable_scroll="${3:-0}"
  local loop="${4:-0}"
  local fpaths="${@:5}"

  while true; do
    for fpath in ${fpaths[@]}; do
      scroll "$fpath" "$enable_scroll" "$delay" || continue
      echo -n "Press [any key] to exit, or wait $pause_time seconds to continue scrolling..."
      wait_for_keypress "$pause_time" && continue || true
    done
    [[ "$loop" == "1" ]] || return 0
  done
}

fpaths=() delay=0.15 pause_time=5 enable_scroll=0 loop=0
while [[ $# -gt 0 ]]; do
  case "$1" in
    -h|--help)      usage; exit 0 ;;
    -d|--delay)     shift; delay="$1"; shift ;;
    -p|--pause)     shift; pause_time="$1"; shift ;;
    -l|--loop)             loop=1; shift ;;
    -N|--no-scroll)        enable_scroll=1; shift ;;
    *)
      fpaths+=("$1"); shift ;;
  esac
done

# echo "delay: $delay, pause_time: $pause_time, enable_scroll: $enable_scroll"
# exit 0

if [[ "${#fpaths[@]}" -gt 0 ]]; then scroll_all "$delay" "$pause_time" "$enable_scroll" "$loop" "${fpaths[@]}"
else echo "No file specified" >&2; usage; exit 1
fi
