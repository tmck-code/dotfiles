#!/usr/bin/env bash

set +x

function decrypt_secret() {
  local secret_file="$1"
  local recipient="$2"
  local key="$3"

  gpg --quiet --batch --yes --decrypt --recipient "$recipient" "$secret_file" |
    grep "^export ${key}=\"" |
    cut -d= -f2 |
    tr -d '"'
}

function usage() {
  echo "Usage: $0 [-k|--key <key-id>] [-r|--recipient <recipient>]"
  echo -e "e.g.\n    export \$(secrets-load-gpg -k MYSECRET -r my@email.com)"
  exit 1
}

key="" recipient=""
case "$1" in
-k | --key)
  shift
  key="$1"
  shift
  ;;
-r | --recipient)
  shift
  recipient="$1"
  shift
  ;;
*) usage ;;
esac

if [ -t 1 ]; then
  echo -e "\e[3;41m !! Warning! do NOT print the result of this script to STDOUT !! \e[0m\n"
  usage
fi

echo "$key=$(decrypt_secret ~/.secrets.gpg "$recipient" "$key")"
