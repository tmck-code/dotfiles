#!/bin/bash
#
# finds all the screenshots for the surf map under
# /mnt/X/SteamLibrary/steamapps/common/Momentum\ Mod\ Playtest/momentum/screenshots/
# and creates a .titled.jpg version of each with the surf map name annotated
# e.g. surf_harmony0000.jpg  -> surf_harmony0000.titled.jpg

set -euo pipefail

[ -n "${DEBUG:-}" ] && set -x

SCREENSHOT_DIR="/mnt/X/SteamLibrary/steamapps/common/Momentum Mod Playtest/momentum/screenshots"

function create_annotated_image() {
  local surf_map_name="$1"
  local infpath="$2"
  local oftfpath="$3"

  overlay_tmp_path="/tmp/surf_overlay.png"

  # create the overlay
  magick -size 2560x1440 xc:none -font /usr/share/fonts/OTF/FiraSansCompressed-Bold.otf \
    -pointsize 300 -gravity SouthWest -fill none -stroke white -strokewidth 10 -annotate +100+350 "surf" \
    -pointsize 400 -fill white -stroke none -annotate +100+50 "$surf_map_name" \
    "$overlay_tmp_path"

  # composite the overlay onto the original image
  magick "$infpath" "$overlay_tmp_path" -gravity NorthWest -composite "$outfpath"
}

function annotate_all() {
  local surf_map_name="$1"

  for infpath in "$SCREENSHOT_DIR"/*"$surf_map_name"*.jpg; do
    local outfpath="${infpath%.*}.titled.jpg"
    echo "Annotating $infpath -> $outfpath"
    create_annotated_image "$surf_map_name" "$infpath" "$outfpath"
  done
}

function usage() {
  echo "Usage: $0 [-o|--output <output file>] [-m|--map-name <map name>]" >&2
}

surf_map_name=
while test $# -gt 0; do
  case "$1" in
    -h|--help) usage; exit 0 ;;
    -m|--map)  shift; surf_map_name="$1";   shift ;;
    *)
      echo "Wrong arg: $1" >&2; usage; exit 1 ;;
  esac
done

annotate_all "$surf_map_name"
